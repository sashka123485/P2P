<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä P2P</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 900px;
            height: 90vh;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .left-panel {
            width: 300px;
            background: #f8f9fa;
            padding: 20px;
            border-right: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        
        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }
        
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .message {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
        }
        
        .message.self {
            align-self: flex-end;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 5px;
        }
        
        .message.other {
            align-self: flex-start;
            background: white;
            color: #333;
            border: 1px solid #e9ecef;
            border-bottom-left-radius: 5px;
        }
        
        .message.system {
            align-self: center;
            background: #e9ecef;
            color: #666;
            font-size: 14px;
            max-width: 90%;
            text-align: center;
            padding: 10px;
            border-radius: 10px;
        }
        
        .message .meta {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        .input-area {
            display: flex;
            gap: 10px;
        }
        
        .input-area input {
            flex: 1;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border 0.3s;
        }
        
        .input-area input:focus {
            border-color: #667eea;
        }
        
        .input-area button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 0 25px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }
        
        .input-area button:hover {
            transform: translateY(-2px);
        }
        
        .input-area button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .status {
            text-align: center;
            padding: 10px;
            font-size: 14px;
            border-top: 1px solid #e9ecef;
        }
        
        .status.connected {
            color: #28a745;
            background: #f0fff4;
        }
        
        .status.disconnected {
            color: #dc3545;
            background: #fff5f5;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .card h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 18px;
        }
        
        input, select, button {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        button.secondary {
            background: #6c757d;
        }
        
        #yourId, #remoteId {
            font-family: monospace;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            word-break: break-all;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .hidden {
            display: none;
        }
        
        #connectionCode {
            font-size: 32px;
            text-align: center;
            font-weight: bold;
            color: #667eea;
            margin: 20px 0;
            letter-spacing: 5px;
        }
        
        .qr-container {
            text-align: center;
            margin: 20px 0;
        }
        
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196f3;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .main {
                flex-direction: column;
            }
            
            .left-panel {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e9ecef;
            }
            
            .container {
                height: auto;
                max-height: 90vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîó P2P –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</h1>
            <p>–ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –±—Ä–∞—É–∑–µ—Ä–∞–º–∏ –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–æ–≤</p>
        </div>
        
        <div class="main">
            <div class="left-panel">
                <div class="card">
                    <h3>üÜî –í–∞—à ID</h3>
                    <div id="yourId">–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤–∞—à —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID...</div>
                    <button onclick="copyMyId()" id="copyIdBtn">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –º–æ–π ID</button>
                    
                    <div class="qr-container">
                        <canvas id="qrCode"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <h3>üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</h3>
                    <input type="text" id="remoteIdInput" placeholder="–í–≤–µ–¥–∏—Ç–µ ID —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞">
                    <button onclick="connectToPeer()" id="connectBtn">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
                    <button onclick="disconnectPeer()" class="secondary" id="disconnectBtn" disabled>–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
                    
                    <div class="info-box">
                        üì± –ß—Ç–æ–±—ã –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è:
                        <ol style="margin-left: 20px; margin-top: 5px;">
                            <li>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–∞—à ID</li>
                            <li>–û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É</li>
                            <li>–í–≤–µ–¥–∏—Ç–µ ID —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –∑–¥–µ—Å—å</li>
                        </ol>
                    </div>
                </div>
                
                <div class="card">
                    <h3>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                    <div class="info-box">
                        <strong>–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ:</strong> <span id="connectionInfo">–ù–µ –∞–∫—Ç–∏–≤–Ω–æ</span><br>
                        <strong>–°—Ç–∞—Ç—É—Å:</strong> <span id="peerInfo">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                </div>
            </div>
            
            <div class="right-panel">
                <div class="chat-section">
                    <div id="messages" class="messages">
                        <div class="message system">
                            –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ P2P –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä!<br>
                            <small>1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–∞—à ID<br>
                            2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É<br>
                            3. –ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –µ–≥–æ ID –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</small>
                        </div>
                    </div>
                    
                    <div class="input-area">
                        <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." disabled>
                        <button onclick="sendMessage()" disabled id="sendButton">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    </div>
                </div>
                
                <div id="status" class="status disconnected">
                    ‚ùå –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ
                </div>
            </div>
        </div>
    </div>

    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è QR –∫–æ–¥–æ–≤ -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <!-- PeerJS –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let peer = null;
        let conn = null;
        let myId = null;
        let isConnected = false;

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ ID
        function generateId() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < 8; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Peer —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        async function initPeer() {
            try {
                myId = generateId();
                document.getElementById('yourId').textContent = myId;
                document.getElementById('peerInfo').textContent = '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...';
                
                // –°–æ–∑–¥–∞–µ–º Peer —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤
                peer = new Peer(myId, {
                    host: 'peerjs.agora.io',
                    port: 443,
                    path: '/',
                    debug: 3,
                    config: {
                        'iceServers': [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:global.stun.twilio.com:3478' }
                        ]
                    }
                });

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π Peer
                peer.on('open', (id) => {
                    console.log('‚úÖ Peer –ø–æ–¥–∫–ª—é—á–µ–Ω —Å ID:', id);
                    document.getElementById('peerInfo').textContent = '–ì–æ—Ç–æ–≤ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é';
                    updateStatus('‚úÖ –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'connected');
                    generateQRCode(id);
                    updateConnectionInfo('–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
                });

                peer.on('connection', (connection) => {
                    console.log('üîó –í—Ö–æ–¥—è—â–µ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç:', connection.peer);
                    handleIncomingConnection(connection);
                });

                peer.on('disconnected', () => {
                    console.log('‚ö†Ô∏è Peer –æ—Ç–∫–ª—é—á–µ–Ω –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ —Å–∏–≥–Ω–∞–ª–∏–Ω–≥–∞');
                    document.getElementById('peerInfo').textContent = '–û—Ç–∫–ª—é—á–µ–Ω –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞';
                    if (!isConnected) {
                        updateStatus('‚ö†Ô∏è –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º –ø–æ—Ç–µ—Ä—è–Ω–æ', 'disconnected');
                    }
                });

                peer.on('close', () => {
                    console.log('‚ùå Peer –∑–∞–∫—Ä—ã—Ç');
                    document.getElementById('peerInfo').textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ';
                });

                peer.on('error', (err) => {
                    console.error('‚ùå Peer –æ—à–∏–±–∫–∞:', err);
                    document.getElementById('peerInfo').textContent = '–û—à–∏–±–∫–∞: ' + err.type;
                    
                    if (err.type === 'unavailable-id') {
                        // –ï—Å–ª–∏ ID –∑–∞–Ω—è—Ç, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π
                        setTimeout(() => {
                            initPeer();
                        }, 1000);
                    }
                });

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                document.getElementById('peerInfo').textContent = '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏';
                updateStatus('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'disconnected');
                
                // –ü–æ–ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(initPeer, 3000);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        function handleIncomingConnection(connection) {
            if (conn && conn.open) {
                connection.close();
                addSystemMessage('–£–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ');
                return;
            }

            conn = connection;
            setupConnection();
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        function setupConnection() {
            conn.on('open', () => {
                console.log('‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Å:', conn.peer);
                isConnected = true;
                
                const shortId = conn.peer.substring(0, 8);
                updateStatus('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ ' + shortId, 'connected');
                updateConnectionInfo(`–ü–æ–¥–∫–ª—é—á–µ–Ω –∫: ${shortId}...`);
                
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendButton').disabled = false;
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;
                
                addSystemMessage(`–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Å ${shortId}...`);
            });

            conn.on('data', (data) => {
                console.log('üì® –ü–æ–ª—É—á–µ–Ω–æ:', data);
                try {
                    if (typeof data === 'string') {
                        data = JSON.parse(data);
                    }
                    
                    if (data.type === 'message') {
                        const time = data.timestamp ? new Date(data.timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
                        addMessage(data.text, `–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ (${conn.peer.substring(0, 8)}...)`, false, time);
                    }
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', e);
                }
            });

            conn.on('close', () => {
                console.log('üîå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ');
                handleDisconnection();
            });

            conn.on('error', (err) => {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:', err);
                handleDisconnection();
            });
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è
        function handleDisconnection() {
            isConnected = false;
            conn = null;
            
            updateStatus('‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ', 'disconnected');
            updateConnectionInfo('–ù–µ –∞–∫—Ç–∏–≤–Ω–æ');
            
            document.getElementById('messageInput').disabled = true;
            document.getElementById('sendButton').disabled = true;
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('disconnectBtn').disabled = true;
            
            addSystemMessage('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ');
        }

        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –¥—Ä—É–≥–æ–º—É –ø–∏—Ä—É
        function connectToPeer() {
            const remoteId = document.getElementById('remoteIdInput').value.trim();
            if (!remoteId) {
                alert('–í–≤–µ–¥–∏—Ç–µ ID —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞');
                return;
            }

            if (remoteId === myId) {
                alert('–ù–µ–ª—å–∑—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–∞–º–æ–º—É —Å–µ–±–µ!');
                return;
            }

            if (conn && conn.open) {
                alert('–£–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ');
                return;
            }

            if (peer) {
                try {
                    console.log('üîÑ –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫:', remoteId);
                    conn = peer.connect(remoteId, {
                        reliable: true,
                        serialization: 'json'
                    });
                    
                    addSystemMessage(`–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ ${remoteId.substring(0, 8)}...`);
                    updateConnectionInfo(`–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫: ${remoteId.substring(0, 8)}...`);
                    
                    setupConnection();
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error);
                    alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message);
                }
            } else {
                alert('Peer –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ü–æ–¥–æ–∂–¥–∏—Ç–µ...');
            }
        }

        // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ
        function disconnectPeer() {
            if (conn) {
                conn.close();
                handleDisconnection();
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text) {
                return;
            }

            if (conn && conn.open) {
                const message = {
                    type: 'message',
                    text: text,
                    sender: myId,
                    timestamp: new Date().toISOString()
                };
                
                try {
                    conn.send(message);
                    addMessage(text, '–í—ã', true, new Date().toLocaleTimeString());
                    input.value = '';
                    input.focus();
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
                    addSystemMessage('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
                }
            } else {
                addSystemMessage('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
        function addMessage(text, sender, isSelf, time = null) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            
            messageDiv.className = `message ${isSelf ? 'self' : 'other'}`;
            
            const displayTime = time || new Date().toLocaleTimeString();
            messageDiv.innerHTML = `
                <div><strong>${sender}:</strong> ${text}</div>
                <div class="meta">${displayTime}</div>
            `;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        function addSystemMessage(text) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            
            messageDiv.className = 'message system';
            messageDiv.textContent = text;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // –ê–≤—Ç–æ-–ø—Ä–æ–∫—Ä—É—Ç–∫–∞
            setTimeout(() => {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }, 100);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        function updateStatus(text, className) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = text;
            statusDiv.className = `status ${className}`;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏
        function updateConnectionInfo(text) {
            document.getElementById('connectionInfo').textContent = text;
        }

        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–≤–æ–µ–≥–æ ID
        function copyMyId() {
            navigator.clipboard.writeText(myId)
                .then(() => {
                    const btn = document.getElementById('copyIdBtn');
                    const originalText = btn.textContent;
                    btn.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                    setTimeout(() => {
                        btn.textContent = originalText;
                    }, 2000);
                })
                .catch(err => {
                    console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID');
                });
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–∞
        function generateQRCode(text) {
            const canvas = document.getElementById('qrCode');
            const qrText = window.location.origin + window.location.pathname + '?connect=' + text;
            
            QRCode.toCanvas(canvas, qrText, {
                width: 128,
                height: 128,
                margin: 1,
                color: {
                    dark: '#667eea',
                    light: '#ffffff'
                }
            }, function(error) {
                if (error) {
                    console.error('QR Code error:', error);
                    canvas.style.display = 'none';
                }
            });
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ URL –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        function checkUrlForConnection() {
            const urlParams = new URLSearchParams(window.location.search);
            const connectTo = urlParams.get('connect');
            
            if (connectTo && connectTo !== myId) {
                setTimeout(() => {
                    document.getElementById('remoteIdInput').value = connectTo;
                    addSystemMessage(`–û–±–Ω–∞—Ä—É–∂–µ–Ω ID –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${connectTo.substring(0, 8)}...`);
                }, 1000);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            initPeer();
            
            // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å URL –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            setTimeout(checkUrlForConnection, 2000);
            
            // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            setInterval(() => {
                if (peer && !peer.disconnected && !peer.destroyed) {
                    if (!peer.open) {
                        document.getElementById('peerInfo').textContent = '–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
                    }
                }
            }, 5000);
        };

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', function() {
            if (conn) {
                conn.close();
            }
            if (peer) {
                peer.destroy();
            }
        });
    </script>
</body>
</html>
